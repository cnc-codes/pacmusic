name: Deploy Staging Server

on:
  push:
    branches:
      - main

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: Staging

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Deploy to Staging
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST_STAGING }}
          username: ${{ secrets.SSH_USER_NAME_STAGING }}
          key: ${{ secrets.SSH_PRIVATE_KEY_STAGING }}
          script: |
            set -euo pipefail
            IFS=$'\n\t'
            log() { echo "[$(date +'%H:%M:%S')] $*"; }

            log "ðŸ“‚ Deploying to staging server..."

            GIT_URL=${{ secrets.GIT_URL }}
            APP_STG_PATH=${{ vars.APP_STG_PATH }}
            STG_DOMAIN=${{ vars.STG_DOMAIN }}
            STG_EMAIL=${{ secrets.EMAIL }}
            APP_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/pacmusic
            APP_TAG=latest

            if [[ -d "$APP_STG_PATH/pacmusic/.git" ]]; then
              cd $APP_STG_PATH/pacmusic && git fetch --all && git reset --hard origin/main
            else
              rm -rf $APP_STG_PATH/pacmusic
              git clone $GIT_URL $APP_STG_PATH/pacmusic
              cd $APP_STG_PATH/pacmusic
            fi

            cat > .env <<EOF
              APP_STG_PORT_1=${{ vars.APP_STG_PORT_1 }}
              APP_STG_PORT_2=${{ vars.APP_STG_PORT_2 }}
              STG_DOMAIN=$STG_DOMAIN
              STG_EMAIL=$STG_EMAIL
              APP_IMAGE=$APP_IMAGE
              APP_TAG=$APP_TAG
              EOF

            log "ðŸ³ Pulling Docker image..."
            docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}
            docker compose pull || docker pull $APP_IMAGE:$APP_TAG

            log "ðŸ›‘ Stopping old containers..."
            docker compose down || true

            if [ ! -d "./nginx/ssl/live/$STG_DOMAIN" ]; then
              log "ðŸ” Requesting SSL certificate..."
              docker compose run --rm pacmusic-certbot || true
            fi

            log "ðŸš€ Starting staging containers..."
            COMPOSE_PROFILES=Staging docker